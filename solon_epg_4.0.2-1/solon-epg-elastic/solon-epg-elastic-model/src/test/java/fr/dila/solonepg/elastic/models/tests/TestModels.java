package fr.dila.solonepg.elastic.models.tests;

import com.fasterxml.jackson.core.JsonFactory;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import org.elasticsearch.action.search.SearchResponse;
import org.elasticsearch.common.xcontent.ContextParser;
import org.elasticsearch.common.xcontent.DeprecationHandler;
import org.elasticsearch.common.xcontent.NamedXContentRegistry;
import org.elasticsearch.common.xcontent.ParseField;
import org.elasticsearch.common.xcontent.XContentParser;
import org.elasticsearch.common.xcontent.json.JsonXContent;
import org.elasticsearch.common.xcontent.json.JsonXContentParser;
import org.elasticsearch.core.TimeValue;
import org.elasticsearch.search.SearchHits;
import org.elasticsearch.search.aggregations.Aggregation;
import org.elasticsearch.search.aggregations.bucket.terms.ParsedStringTerms;
import org.elasticsearch.search.aggregations.bucket.terms.StringTerms;
import org.elasticsearch.search.aggregations.metrics.ParsedTopHits;
import org.elasticsearch.search.aggregations.metrics.TopHitsAggregationBuilder;
import org.elasticsearch.search.fetch.subphase.highlight.HighlightField;
import org.junit.Assert;
import org.junit.Test;

public class TestModels {

    @Test
    @SuppressWarnings(value = "unchecked")
    public void testDeserialisationResponse() throws IOException {
        // flux avec objets Elastic Dossiers
        String json1Path = "json/exemple-json-depuis-elastic-1.json";
        String fluxJson1 = ModelsUtils.getFileContent(json1Path, getClass().getClassLoader());

        JsonXContentParser xContentParser = new JsonXContentParser(
            NamedXContentRegistry.EMPTY,
            DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
            new JsonFactory().createParser(fluxJson1)
        );
        SearchResponse sr = SearchResponse.fromXContent(xContentParser);
        Map<String, Object> source = sr.getHits().getHits()[0].getSourceAsMap();

        Assert.assertEquals(new TimeValue(14), sr.getTook());
        Assert.assertFalse(sr.isTimedOut());
        Assert.assertEquals(1, sr.getHits().getTotalHits().value);
        Assert.assertEquals(0, Float.compare(sr.getHits().getMaxScore(), 1f));
        Assert.assertEquals("84317a03-4d6d-4caf-a616-f3ed5d104317", sr.getHits().getHits()[0].getId());
        Assert.assertEquals("data1524573071546", sr.getHits().getHits()[0].getIndex());
        Assert.assertEquals(1L, sr.getHits().getHits()[0].getScore(), 0);
        Assert.assertEquals("84317a03-4d6d-4caf-a616-f3ed5d104317", source.get("UID"));
        ArrayList<Object> documents = new ArrayList<>((Collection<?>) source.get("documents"));
        Assert.assertEquals(3, documents.size());
        Map<String, Object> document = (Map<String, Object>) documents.get(2);
        Assert.assertEquals(
            "PAGE  \n3/17\nNOR : OMEX1312956L/Rose-1\n\n\nPROJET DE LOI ORGANIQUE\nportant actualisation de la loi n° 99-209 du 19 mars 1999 relative à la Nouvelle-Calédonie\n\nNOR : OMEX1312956L/Rose-1\n------\n\nTITRE Ier\nDISPOSITIONS VISANT A AMELIORER\n\nL’EXERCICE DE SES COMPETENCES PAR LA NOUVELLE-CALEDONIE\nChapitre Ier\nRenforcement de l’exercice des compétences\nexercées par la Nouvelle-Calédonie \n\nArticle 1er\n\nAprès l’article 27 de la loi organique n° 99-209 du 19 mars 1999 relative à la Nouvelle‑Calédonie, il est inséré un article 27-1 ainsi rédigé :\n\n« Art. 27-1. - I. - L’Autorité de la concurrence de la Nouvelle-Calédonie est une autorité administrative indépendante. \n« Elle veille au respect de la réglementation applicable en Nouvelle-Calédonie en matière de concurrence, de concentration économique et d’aménagement commercial.\n« L’Etat définit l’organisation de cette autorité administrative indépendante, ses attributions, ses procédures, ses modes de décisions et les voies de recours ainsi que les sanctions aux infractions.\n« II. - L’Autorité de la concurrence de la Nouvelle-Calédonie peut, par convention, faire appel à l’expertise de l’Autorité de la concurrence nationale.\n\n« III. - L'Autorité de la concurrence de la Nouvelle-Calédonie est obligatoirement consultée par le gouvernement ou le congrès sur tout projet de texte instituant un régime nouveau ayant directement pour effet :\n« 1° De soumettre l'exercice d'une profession ou l'accès à un marché à des restrictions quantitatives ; \n« 2° D'établir des droits exclusifs dans certaines zones ;\n« 3° D'imposer des pratiques uniformes en matière de prix ou de conditions de vente.\n« Elle peut être aussi consultée par le congrès de Nouvelle-Calédonie sur toute question entrant dans le champ de ses compétences. Son président peut être entendu dans ce cadre.\n« Elle donne son avis sur toute question de concurrence à la demande du gouvernement. Elle peut également donner son avis sur les mêmes questions à la demande des provinces, des organisations professionnelles et syndicales, des organisations de consommateurs, en ce qui concerne les intérêts dont ils ont la charge.\n\n« IV. - A la demande du congrès, le président de l’Autorité de la concurrence de la Nouvelle-Calédonie rend compte des activités de celle-ci.\n« L’Autorité de la concurrence de la Nouvelle-Calédonie établit chaque année, avant le 30 juin, un rapport public rendant compte de son activité qu’elle adresse au gouvernement et au congrès. \n\n« V. - Les crédits attribués à l’Autorité de la concurrence de la Nouvelle-Calédonie pour son fonctionnement sont inscrits au budget de la Nouvelle-Calédonie. »\nArticle 2\nI. - Après l’article 27-1 de la même loi organique, il est inséré un article 27-2 ainsi rédigé :\n\n« Art. 27-2. - I. - Dans les domaines relevant de sa compétence, le congrès peut créer des autorités administratives indépendantes.\n« La loi du pays qui porte création d’une autorité administrative indépendante définit ses attributions, ses procédures, ses modes de décisions et les voies de recours ainsi que les sanctions.\n« Le congrès est autorisé à déléguer ses compétences propres, définies par la présente loi organique, lorsque cette dérogation est nécessaire à l’exercice des compétences de l’autorité administrative indépendante.\n« L’Etat définit la composition et le mode de désignation des membres de chacune des autorités administratives indépendantes. Il procède à la nomination de leurs membres.\n\n« II. - Après le 12° de l’article 99 de la même loi organique, il est inséré un 13° ainsi rédigé :\n\n« 13° Création d’autorités administratives indépendantes, en application de l’article 27-2, dans les domaines relevant de sa compétence. » \n\nArticle 3\nI. - L’article 134 de la même loi organique est ainsi modifié :\n\n1° Après le deuxième alinéa, sont insérés deux alinéas ainsi rédigés :\n« Dans les matières relevant de la compétence de la Nouvelle-Calédonie, le président du gouvernement exerce les pouvoirs de police administrative liés à l’exercice de ces compétences, sous réserve des pouvoirs dévolus aux autres autorités administratives investies d’un pouvoir de police.\n« Pour l’exercice des compétences dévolues à la Nouvelle-Calédonie, et en tant que de besoin, le président du gouvernement peut réquisitionner les personnes et les moyens nécessaires. » ;\n2° Après l’avant-dernier alinéa, il est inséré un alinéa ainsi rédigé :\n« Les personnes mentionnées à l’alinéa précédent peuvent donner délégation aux agents placés sous leur autorité pour signer tous les actes relatifs aux affaires pour lesquelles elles ont elles-mêmes reçu délégation dans des conditions fixées par décret. »\n\nII. - L’article 126 de la même loi organique est complété par un alinéa ainsi rédigé :\n\n« Sous réserve des dispositions de l’article 134, des actes prévus à l’article 99 dénommés « lois du pays » et des délibérations du congrès qui en attribue la compétence au président du gouvernement, il prend les actes à caractère non réglementaire nécessaires à la mise en œuvre des délibérations du congrès et de la commission permanente. »\n\nArticle 4\nAprès la quatrième phrase de l’article 173 de la même loi organique, est insérée une phrase ainsi rédigée : \n« Sans préjudice des compétences détenues par le maire et par le gouvernement de la Nouvelle-Calédonie au titre de leurs pouvoirs de police de la circulation, il exerce les pouvoirs de police sur ce domaine. »\nChapitre II\n\nClarification des compétences\n\nexercées par la Nouvelle-Calédonie\n\nArticle 5\nI. - Au 11° de l’article 22, au premier alinéa de l’article 40 et au premier alinéa du II de l’article 42 de la même loi organique, les mots : « et au cobalt » sont remplacés par les mots : « , au cobalt et aux « terres rares » ».\nII. - Au deuxième alinéa de l’article 41 de la même loi organique, les mots : « ou au cobalt » sont remplacés par les mots : « , au cobalt ou aux « terres rares » ».\n\nIII. - Au 6° de l’article 99 de la même loi organique, les mots : « et le cobalt » sont remplacés par les mots : « le cobalt et les « terres rares » ».\n\nTITRE II\n\nDISPOSITIONS VISANT A MODERNISER\n\nLE FONCTIONNEMENT DES INSTITUTIONS\n\nChapitre Ier\nActualisation de la dénomination du conseil économique et social\n\nArticle 6\nI. - Dans toutes les dispositions de la même loi organique, les mots : « conseil économique et social » sont remplacés par les mots : « conseil économique, social et environnemental ».\nII. - A l’article 153, après les mots : « vie économique, sociale ou culturelle » sont ajoutés les mots : « ou la protection de l’environnement ».\nChapitre II\n\nStatut de l’élu\n\nArticle 7\nAux articles 125 et 163 de la même loi organique, les mots : « de chef d’administration principale de première classe » sont remplacés par les mots : « du corps le plus élevé du cadre d’administration générale de la Nouvelle-Calédonie. »\n\nArticle 8\nLe deuxième alinéa de l’article 138-1 de la même loi organique est complété par les mots : « sans préjudice des dispositions prévues au quatrième alinéa de l’article 153. »\nChapitre III\n\nAmélioration du fonctionnement des institutions\n\nArticle 9\nI. - Après l'article 158 de la même loi organique, il est inséré un article 158-1 ainsi rédigé : \n« Art. 158-1. - La délibération de l’assemblée de province chargeant son président de souscrire un marché déterminé peut être prise avant l’engagement de la procédure de passation de ce marché. Elle comporte alors obligatoirement la définition de l’étendue du besoin à satisfaire et le montant prévisionnel du marché. \n\n« L’assemblée de province peut à tout moment décider que la signature du marché ne pourra intervenir qu’après une nouvelle délibération, une fois connus l’identité de l’attributaire et le montant du marché. »\n\nII. - Après l'article 177 de la même loi organique, il est inséré un article 177-1 ainsi rédigé : \n\n« Art. 177-1. - Le président de l’assemblée de province peut, par délégation de l’assemblée, être chargé pour la durée de son mandat de prendre toute décision concernant la préparation, la passation, l’exécution et le règlement des contrats de travaux, de fournitures et de services qui peuvent être réglementairement passés de gré à gré lorsque les crédits sont inscrits au budget. Le président de l’assemblée de province rend compte à la plus proche réunion utile de l’assemblée de province de l’exercice de cette compétence. »\n\nIII. - Après l'article 177-1 de la même loi organique, il est inséré un article 177-2 ainsi rédigé : \n« Art. 177-2. - Lorsqu’il n’est pas fait application de l’article 177-1, la délibération de l’assemblée de province chargeant son président de souscrire un marché déterminé peut être prise avant l’engagement de la procédure de passation de ce marché. Elle comporte alors obligatoirement la définition de l’étendue du besoin à satisfaire et le montant prévisionnel du marché. »\n\nArticle 10\nA l’article 128 de la même loi organique, il est inséré un cinquième alinéa ainsi rédigé :\n\n« Le gouvernement fixe son règlement intérieur. Ce règlement peut être déféré au tribunal administratif. Il est publié au Journal officiel de la Nouvelle-Calédonie. »\n\nArticle 11\nL’article 166 de la même loi organique, est remplacé par les dispositions suivantes :\n\n« Art. 166 - Tout membre d’une assemblée de province a le droit, dans le cadre de sa fonction, d’être informé des affaires de la province qui font l’objet d’une délibération. »\n\nArticle 12\nAprès le premier alinéa du I de l’article 204 de la même loi organique, il est inséré un deuxième alinéa ainsi rédigé :\n\n« La publication au Journal officiel de la Nouvelle-Calédonie des actes mentionnés au II peut être effectuée par voie électronique dans des conditions de nature à garantir leur authenticité. »\n\nChapitre IV\n\nModernisation des dispositions financières et comptables\n\nArticle 13\nI. - Après l'article 52 de la même loi organique, il est inséré un article 52-1 ainsi rédigé :\n\n« Art. 52-1. - \nI. - La Nouvelle-Calédonie et ses établissements publics sont tenus de déposer toutes leurs disponibilités auprès de l’Etat.\n« II. - La Nouvelle-Calédonie peut déroger à l'obligation de dépôt de ses fonds, dans les conditions prévues aux I, II, IV et V de l'article L. 1618-2 du code général des collectivités territoriales.\n\nII. - Le 14° de l'article 127 de la même loi organique est complété par les mots : « , et prend les décisions de déroger à l'obligation de dépôt des fonds auprès de l'État, dans les conditions prévues par l'article 52-1 de la présente loi organique. »\n\nArticle 14\nAprès l’article 53 de la même loi organique, il est inséré un article 53‑1 ainsi rédigé :\n\n« Art. 53-1. - La Nouvelle-Calédonie, les provinces et leurs établissements publics peuvent créer, dans le cadre des compétences qui leur sont attribuées par la loi, des sociétés publiques locales dont ils détiennent la totalité du capital. \n\n« Ces sociétés sont compétentes pour réaliser des opérations d'aménagement, des opérations de construction ou pour exploiter des services publics à caractère industriel et commercial ou pour toute autre activité d'intérêt général.\n\n« Ces sociétés exercent leurs activités exclusivement pour le compte de leurs actionnaires et sur le territoire des collectivités et des établissements publics qui en sont membres. »\n\nArticle 15\nI. - Après l’article 84-3 de la même loi organique, il est inséré un article 84-4 ainsi rédigé :\n\n« Art. 84-4. - I. - Toute association, œuvre ou entreprise ayant reçu une subvention peut être soumise au contrôle de l’autorité de la Nouvelle-Calédonie qui l'a accordée.\n\n« Tous groupements, associations, œuvres ou entreprises privées qui ont reçu dans l'année en cours une ou plusieurs subventions sont tenus de fournir à l'autorité qui a mandaté la subvention une copie certifiée de leurs budgets et de leurs comptes de l'exercice écoulé, ainsi que tous documents faisant connaître les résultats de leur activité.\n\n« Il est interdit à tout groupement ou à toute association, œuvre ou entreprise ayant reçu une subvention d'en employer tout ou partie en subventions à d'autres associations, œuvres ou entreprises, sauf lorsque cela est expressément prévu dans la convention conclue entre la Nouvelle-Calédonie et l'organisme subventionné.\n\n« II. - L'autorité administrative qui attribue une subvention doit, lorsque cette subvention dépasse un seuil défini par décret, conclure une convention avec l'organisme de droit privé qui en bénéficie, définissant l'objet, le montant et les conditions d'utilisation de la subvention attribuée. \n\n« Lorsque la subvention est affectée à une dépense déterminée, l'organisme de droit privé bénéficiaire doit produire un compte rendu financier qui atteste de la conformité des dépenses effectuées à l'objet de la subvention. Le compte rendu financier est déposé auprès de l'autorité administrative qui a versé la subvention dans les six mois suivant la fin de l'exercice pour lequel elle a été attribuée. \n\n« Le budget et les comptes de tout organisme de droit privé ayant reçu une subvention, la convention prévue au présent article et le compte rendu financier de la subvention doivent être communiqués à toute personne qui en fait la demande par l'autorité administrative ayant attribué la subvention ou celles qui les détiennent, dans les conditions prévues par la loi n° 78-753 du 17 juillet 1978 portant diverses mesures d'amélioration des relations entre l'administration et le public et diverses dispositions d'ordre administratif, social et fiscal. \n\n« Les organismes de droit privé ayant reçu annuellement de l'ensemble des autorités administratives une subvention supérieure à un montant fixé par décret doivent déposer au haut‑commissariat de Nouvelle-Calédonie leur budget, leurs comptes, les conventions prévues au présent article et, le cas échéant, les comptes rendus financiers des subventions reçues pour y être consultés. \n\n« La formalité de dépôt au haut-commissariat de Nouvelle-Calédonie, prévue à l'alinéa précédent, n'est pas exigée des organismes ayant le statut d'association ou de fondation. »\n\nII. - Après l’article 183-3 de la même loi organique, il est inséré un article 184-4 ainsi rédigé :\n\n« Art. 183-4. - I. - Toute association, œuvre ou entreprise ayant reçu une subvention peut être soumise au contrôle de la province qui l'a accordée.\n\n« Tous groupements, associations, œuvres ou entreprises privées qui ont reçu dans l'année en cours une ou plusieurs subventions sont tenus de fournir à l'autorité qui a mandaté la subvention une copie certifiée de leurs budgets et de leurs comptes de l'exercice écoulé, ainsi que tous documents faisant connaître les résultats de leur activité.\n\n« Il est interdit à tout groupement ou à toute association, œuvre ou entreprise ayant reçu une subvention d'en employer tout ou partie en subventions à d'autres associations, œuvres ou entreprises, sauf lorsque cela est expressément prévu dans la convention conclue entre la province et l'organisme subventionné.\n\n« II. - L'autorité administrative qui attribue une subvention doit, lorsque cette subvention dépasse un seuil défini par décret du ministre chargé de l’outre-mer, conclure une convention avec l'organisme de droit privé qui en bénéficie, définissant l'objet, le montant et les conditions d'utilisation de la subvention attribuée. \n\n« Lorsque la subvention est affectée à une dépense déterminée, l'organisme de droit privé bénéficiaire doit produire un compte rendu financier qui atteste de la conformité des dépenses effectuées à l'objet de la subvention. Le compte rendu financier est déposé auprès de l'autorité administrative qui a versé la subvention dans les six mois suivant la fin de l'exercice pour lequel elle a été attribuée. \n\n« Le budget et les comptes de tout organisme de droit privé ayant reçu une subvention, la convention prévue au présent article et le compte rendu financier de la subvention doivent être communiqués à toute personne qui en fait la demande par l'autorité administrative ayant attribué la subvention ou celles qui les détiennent, dans les conditions prévues par la loi n° 78-753 du 17 juillet 1978 portant diverses mesures d'amélioration des relations entre l'administration et le public et diverses dispositions d'ordre administratif, social et fiscal. \n\n« Les organismes de droit privé ayant reçu annuellement de l'ensemble des autorités administratives une subvention supérieure à un montant fixé par décret doivent déposer au haut‑commissariat de Nouvelle-Calédonie leur budget, leurs comptes, les conventions prévues au présent article et, le cas échéant, les comptes rendus financiers des subventions reçues pour y être consultés. \n\n« La formalité de dépôt au haut-commissariat de Nouvelle-Calédonie, prévue à l'alinéa précédent, n'est pas exigée des organismes ayant le statut d'association ou de fondation. » \n\nArticle 16\nAprès l’article 209-16 de la même loi organique, il est inséré un article 209-16-1 ainsi rédigé :\n\n« Art. 209-16-1. - I. - Le résultat excédentaire de la section de fonctionnement dégagé au titre de l’exercice clos, cumulé avec le résultat antérieur reporté, est affecté en totalité dès la plus proche décision budgétaire suivant le vote du compte administratif de la Nouvelle-Calédonie et de la province et, en tout état de cause, avant la clôture de l’exercice suivant. La délibération d’affectation prise par le congrès ou l’assemblée de province est produite à l’appui de la décision budgétaire de reprise de ce résultat.\n\n« Le résultat déficitaire de la section de fonctionnement, le besoin de financement ou l’excédent de la section d’investissement sont repris en totalité dès la plus proche décision budgétaire suivant le vote du compte administratif de la Nouvelle-Calédonie et de la province et, en tout état de cause, avant la fin de l’exercice.\n\n« II. - Entre la date limite de mandatement fixée au dernier alinéa de l’article 208-6 et avant l’adoption de son compte administratif, le congrès ou l’assemblée de province peut, au titre de l’exercice clos, reporter de manière anticipée au budget le résultat de la section de fonctionnement, le besoin de financement de la section d’investissement, ainsi que la prévision d’affectation.\n\n« Si le compte administratif fait apparaitre une différence avec les montants reportés par anticipation, le congrès ou l’assemblée de province procède à leur régularisation et à la reprise du résultat dans la plus proche décision budgétaire suivant le vote du compte administratif et, en tout état de cause, avant la fin de l’exercice.\n\n« Un décret fixe les conditions d’application du présent article. »\n\nArticle 17\nI. - Après l’article 209-25 de la même loi organique , il est inséré un article 209-26 ainsi rédigé :\n\n« Art. 209-26. - La Nouvelle-Calédonie et les provinces ne peuvent prendre en charge, dans leur budget propre, des dépenses afférentes à leurs établissements publics à caractère industriel et commercial.\n\n« Toutefois, le congrès de la Nouvelle-Calédonie et les assemblées des provinces peuvent décider une telle prise en charge lorsque celle-ci est justifiée par l’une des raisons suivantes :\n« - lorsque les exigences du service public conduisent la collectivité à imposer des contraintes particulières de fonctionnement ;\n« - lorsque le fonctionnement du service public exige la réalisation d’investissements qui, en raison de leur importance et eu égard au nombre d’usagers, ne peuvent être financés sans une augmentation excessive des tarifs ;\n« - lorsque, après la période de réglementation des prix, la suppression de toute prise en charge par le budget de la Nouvelle-Calédonie ou des provinces aurait pour conséquence une hausse excessive des tarifs.\n\n« Les décisions du congrès de la Nouvelle-Calédonie, et des assemblées des provinces doivent, à peine de nullité, être motivées. Ces décisions fixent les règles de calcul et les modalités de versement des dépenses du service prises en charge par la Nouvelle-Calédonie ou, une ou plusieurs provinces, ainsi que les exercices auxquels elles se rapportent. En aucun cas, cette prise en charge ne peut se traduire par la compensation pure et simple d’un déficit d’exploitation. »\n\nII. - L’article 84 de la même loi organique est ainsi modifié :\n\n1° Le deuxième alinéa est remplacé par un alinéa ainsi rédigé : \n\n« Il comprend une section de fonctionnement et une section d’investissement, tant en recettes qu’en dépenses. Certaines interventions, activités ou services, sont individualisés au sein de budgets annexes. Ces budgets annexes sont votés en équilibre réel. » ;\n2° Le septième alinéa est remplacé par les dispositions suivantes :\n« Sont également obligatoires pour la collectivité :\n« - les dotations aux amortissements ;\n« - les dotations aux provisions et aux dépréciations ;\n« - la reprise des subventions d’équipement reçues.\n« Les modalités d’application de ces dispositions sont déterminées par décret. \n\n« Le budget de la collectivité est voté soit par nature, soit par fonction. Si le budget est voté par nature, il comporte, en outre, une présentation croisée par fonction ; s’il est voté par fonction, il comporte une présentation croisée par nature.\n\n« La nomenclature par nature et la nomenclature par fonction sont fixées par arrêté conjoint des ministres chargés de l’outre-mer et du budget.\n\n« Les recettes de la section d’investissement se composent entre autres :\n- des emprunts ;\n- des dotations ;\n- du produit des cessions d’immobilisations, selon des modalités fixées par décret ;\n- des amortissements ;\n- du virement prévisionnel de la section de fonctionnement et du produit de l’affectation du résultat de fonctionnement, conformément à l’article 209-16-1.\n\n« Les recettes non fiscales de la section de fonctionnement se composent des produits d’exploitation, des produits domaniaux, des produits financiers, des remboursements, subventions et participations, des dotations, des travaux d’équipement en régie et réductions de charges, des produits exceptionnels et des résultats antérieurs. \n\n« Elles se composent également du produit de la neutralisation des dotations aux amortissements et de la reprise des subventions d’équipement reçues. Les modalités d’application de ces dispositions sont déterminées par décret. »\nIII. - L’article 183 de la même loi organique est ainsi modifié :\n\n1° Le deuxième alinéa est remplacé par un alinéa ainsi rédigé : \n\n« Il comprend une section de fonctionnement et une section d’investissement, tant en recettes qu’en dépenses. Certaines interventions, activités ou services, sont individualisés au sein de budgets annexes. Ces budgets annexes sont votés en équilibre réel. » ;\n2° Le septième alinéa est remplacé par les dispositions suivantes :\n\n« Sont également obligatoires pour la province :\n« - les dotations aux amortissements ;\n« - les dotations aux provisions ou aux dépréciations ;\n« - la reprise des subventions d’équipement reçues.\n« Les modalités d’application de ces dispositions sont déterminées par décret.\n\n« Le budget de la province est voté soit par nature, soit par fonction. Si le budget est voté par nature, il comporte, en outre, une présentation croisée par fonction ; s’il est voté par fonction, il comporte une présentation croisée par nature.\n\n« La nomenclature par nature et la nomenclature par fonction sont fixées par arrêté conjoint des ministres chargés de l’outre-mer et du budget.\n\n« Les recettes de la section d’investissement se composent entre autres :\n« - des emprunts ;\n« - des dotations ;\n« - du produit des cessions d’immobilisations, selon des modalités fixées par décret ;\n« - des amortissements ;\n« - du virement prévisionnel de la section de fonctionnement et du produit de l’affectation du résultat de fonctionnement, conformément à l’article L. 209-16-1.\n\n« Les recettes non fiscales de la section de fonctionnement se composent des produits d’exploitation, des produits domaniaux, des produits financiers, des remboursements, subventions et participations, des dotations, des travaux d’équipement en régie et réductions de charges, des produits exceptionnels et des résultats antérieurs. \n\n« Elles se composent également du produit de la neutralisation des dotations aux amortissements et de la reprise des subventions d’équipement reçues. Les modalités d’application de ces dispositions sont déterminées par décret. »\n\nArticle 18\nI. - Après le deuxième alinéa de l’article 84-1 de la même loi organique, il est inséré trois alinéas ainsi rédigés :\n\n« En outre, jusqu'à l'adoption du budget ou jusqu'au 15 avril, en l'absence d'adoption du budget avant cette date, le président du gouvernement peut, sur autorisation du congrès, engager, liquider et mandater les dépenses d'investissement, dans la limite du quart des crédits ouverts au budget de l'exercice précédent, non compris les crédits afférents au remboursement de la dette. \n\n« L'autorisation mentionnée à l'alinéa ci-dessus précise le montant et l'affectation des crédits. Pour les dépenses à caractère pluriannuel incluses dans une autorisation de programme ou d'engagement votée sur des exercices antérieurs, le président du gouvernement peut les liquider et les mandater dans la limite des crédits de paiement prévus au titre de l'exercice par la délibération d'ouverture de l'autorisation de programme ou d'engagement. \n\n« Les crédits correspondants, visés aux alinéas ci-dessus, sont inscrits au budget lors de son adoption. Le comptable est en droit de payer les mandats et recouvrer les titres de recettes émis dans les conditions ci-dessus. » \n\nII. - Après le deuxième alinéa de l’article 183-1 de la même loi organique, il est inséré trois alinéas ainsi rédigés :\n\n« En outre, jusqu'à l'adoption du budget ou jusqu'au 15 avril, en l'absence d'adoption du budget avant cette date, le président de l’assemblée de province peut, sur autorisation du l’assemblée, engager, liquider et mandater les dépenses d'investissement, dans la limite du quart des crédits ouverts au budget de l'exercice précédent, non compris les crédits afférents au remboursement de la dette. \n\n« L'autorisation mentionnée à l'alinéa ci-dessus précise le montant et l'affectation des crédits. Pour les dépenses à caractère pluriannuel incluses dans une autorisation de programme ou d'engagement votée sur des exercices antérieurs, le président de l’assemblée de province peut les liquider et les mandater dans la limite des crédits de paiement prévus au titre de l'exercice par la délibération d'ouverture de l'autorisation de programme ou d'engagement. \n\n« Les crédits correspondants, visés aux alinéas ci-dessus, sont inscrits au budget lors de son adoption. Le comptable est en droit de payer les mandats et recouvrer les titres de recettes émis dans les conditions ci-dessus. »\nIII. - L’article 209-6 de la même loi organique est supprimé.\n\nArticle 19\nA l’article 84-2 de la même loi organique, le mot : « quatre » est remplacé par le mot : « deux ».\n\nArticle 20\nL’article 209-25 de la même loi organique est complété par un troisième alinéa ainsi rédigé :\n\n« Un décret fixe pour les établissements publics d’enseignement du second degré de la Nouvelle-Calédonie, les règles d’organisation financières et comptables adaptées à la nature de leur activité. »\n\nREPUBLIQUE FRANÇAISE\r\n\n————\r\n\nMinistère des outre-mer\r\n\n————\r\n\n\r\n\n\r\n\n\r\n\n",
            document.get("file:data")
        );

        // flux avec des fields (stored_fields)
        String fluxJson2 = ModelsUtils.getFileContent(
            "json/exemple-stored-fields-depuis-elastic-1.json",
            getClass().getClassLoader()
        );

        xContentParser =
            new JsonXContentParser(
                NamedXContentRegistry.EMPTY,
                DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
                new JsonFactory().createParser(fluxJson2)
            );
        SearchResponse sr2 = SearchResponse.fromXContent(xContentParser);
        Map<String, HighlightField> highlightFields = sr2.getHits().getHits()[0].getHighlightFields();
        SearchHits innerDocument = sr2.getHits().getHits()[0].getInnerHits().get("documents");

        Assert.assertEquals(new TimeValue(287), sr2.getTook());
        Assert.assertEquals(2436, sr2.getHits().getTotalHits().value);
        Assert.assertEquals(0, Float.compare(sr2.getHits().getMaxScore(), 689.7005f));
        Assert.assertEquals(
            "Loi relative à la réforme du droit <em>d’asile</em>",
            highlightFields.get("dos:titreActe").getFragments()[0].toString()
        );
        Assert.assertEquals(63, innerDocument.getTotalHits().value);
        Assert.assertEquals(3, innerDocument.getHits()[0].getNestedIdentity().getOffset());
        ArrayList<Object> documentsUID = new ArrayList<>(
            innerDocument.getHits()[0].getFields().get("documents.UID").getValues()
        );
        Assert.assertEquals("40ef0ec4-b202-40b5-9e1c-c7fbbcaeac6b", documentsUID.get(0));
        Assert.assertEquals(2, innerDocument.getHits().length);

        // flux avec des facets
        String fluxJson3 = ModelsUtils.getFileContent(
            "json/exemple-avec-facet-depuis-elastic-1.json",
            getClass().getClassLoader()
        );
        NamedXContentRegistry registry = new NamedXContentRegistry(getDefaultNamedXContents());
        XContentParser parser = JsonXContent.jsonXContent.createParser(
            registry,
            DeprecationHandler.THROW_UNSUPPORTED_OPERATION,
            fluxJson3
        );
        SearchResponse sr3 = SearchResponse.fromXContent(parser);

        ParsedStringTerms statut = sr3.getAggregations().get("facet_statut");
        ParsedStringTerms.ParsedBucket statutTerm5 = (ParsedStringTerms.ParsedBucket) statut.getBuckets().get(5);
        ParsedStringTerms.ParsedBucket statutDocCount4 = (ParsedStringTerms.ParsedBucket) statut.getBuckets().get(4);

        Assert.assertEquals(new TimeValue(177), sr3.getTook());
        Assert.assertEquals("Terminé sans publication", statutTerm5.getKey());
        Assert.assertEquals(9788, statutDocCount4.getDocCount());
    }

    public static List<NamedXContentRegistry.Entry> getDefaultNamedXContents() {
        Map<String, ContextParser<Object, ? extends Aggregation>> map = new HashMap<>();
        map.put(TopHitsAggregationBuilder.NAME, (p, c) -> ParsedTopHits.fromXContent(p, (String) c));
        map.put(StringTerms.NAME, (p, c) -> ParsedStringTerms.fromXContent(p, (String) c));
        List<NamedXContentRegistry.Entry> entries = map
            .entrySet()
            .stream()
            .map(
                entry ->
                    new NamedXContentRegistry.Entry(Aggregation.class, new ParseField(entry.getKey()), entry.getValue())
            )
            .collect(Collectors.toList());
        return entries;
    }
}
